<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla Trigrams Oracle - Grok Enhanced</title>
    <link rel="icon" type="image/x-icon" href="/assets/icon/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Playfair Display', serif; background-color: #111827; }
        .screen { min-height: 100vh; width: 100%; position: relative; top: 0; left: 0; display: flex; justify-content: flex-start; align-items: center; flex-direction: column; padding: 2rem; box-sizing: border-box; z-index: 10; }
        .dice-slot { transition: all 0.2s ease-in-out; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 255, 255, 0.1) inset; }
        #grid-screen, #prediction-screen, #manifesto-screen { padding-bottom: 5rem; }
    </style>
</head>
<body>

    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { 'serif': ['Playfair Display', 'serif'] } } }
        }
    </script>

    <img src="assets/images/monogram.png" alt="Monogram" class="fixed top-4 left-4 w-16 h-16 rounded-full shadow-2xl z-50">

    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-teal-500">
            <h3 id="modal-title" class="text-xl font-bold text-yellow-400 mb-4"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition-colors">
                Close
            </button>
        </div>
    </div>
    
    <div id="welcome-screen" 
        class="screen text-white bg-black bg-cover bg-center justify-center"
        style="background-image: url('assets/images/tesla.png'); background-attachment: fixed; background-size: cover;"
    >
        <div class="bg-black/80 p-8 rounded-2xl shadow-2xl backdrop-blur-sm flex flex-col items-center max-w-sm w-full">
            <h1 class="text-6xl text-yellow-400 mb-6 font-extrabold tracking-wider">
                Tesla Trigrams
            </h1>
            <button 
                class="launch-btn text-6xl text-yellow-400 bg-black/50 p-6 rounded-full shadow-2xl transition-transform ring-4 ring-yellow-400 ring-offset-2 ring-offset-black hover:scale-[1.05] active:scale-[0.98]"
                onclick="showScreen('grid-screen', 'welcome-screen')"
            >
                â–³
            </button>
            <p class="mt-2 text-yellow-200 font-semibold">CAST THE COIL</p>
            <button 
                class="mt-6 text-teal-400 bg-black/50 py-3 px-8 rounded-lg font-bold shadow-lg hover:bg-black/70 transition-colors border border-teal-400"
                onclick="showScreen('manifesto-screen', 'welcome-screen')"
            >
                â—Ž MANIFESTO
            </button>
        </div>
        <p class="absolute bottom-4 text-xs text-gray-500 text-center w-full">
            Created by Pan and Hermes
        </p>
    </div>

    <div id="grid-screen" class="screen bg-gray-900 p-4 pt-16 text-white overflow-y-auto" hidden>
        <button 
            class="absolute top-4 right-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors z-20"
            onclick="showScreen('welcome-screen', 'grid-screen')"
        >
            Back
        </button>
        <h2 class="text-3xl text-yellow-400 font-bold mb-8 text-center w-full max-w-md">Cast Your Resonance Grid</h2>

        <div id="grid-container" class="space-y-4 w-full max-w-md">
        </div>
        
        <div class="flex justify-center mt-10 mb-8 w-full max-w-md">
            <button 
                class="bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-4 px-12 rounded-xl text-lg shadow-xl transition-colors w-full"
                onclick="generatePrediction()"
            >
                CALCULATE ORACLE FATE
            </button>
        </div>
    </div>

    <div id="prediction-screen" class="screen bg-gray-900 p-4 pt-16 text-white overflow-y-auto" hidden>
        <button 
            class="absolute top-4 right-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors z-20"
            onclick="showScreen('grid-screen', 'prediction-screen')"
        >
            Back to Grid
        </button>
        <h2 class="text-3xl text-yellow-400 font-bold mb-4 text-center w-full max-w-3xl">The Oracle's Transmission</h2>
        <div id="prediction-output" class="max-w-3xl mx-auto p-4 sm:p-6 rounded-xl bg-gray-800 shadow-2xl w-full">
        </div>
    </div>

    <div id="manifesto-screen" class="screen bg-gray-900 p-4 pt-16 text-white overflow-y-auto" hidden>
        <button 
            class="absolute top-4 right-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors z-20"
            onclick="showScreen('welcome-screen', 'manifesto-screen')"
        >
            Back
        </button>
        <h2 class="text-3xl text-yellow-400 font-bold mb-8 text-center w-full max-w-3xl">The Tesla Trigrams: Vortex Oracle Blueprint</h2>
        <div class="max-w-3xl mx-auto p-4 sm:p-6 rounded-xl bg-gray-800 shadow-2xl text-left w-full">
            <p class="mb-4">Imagine this: Sparks fly when Nikola Tesla's love for the numbers <strong>3, 6, and 9</strong>â€”the "key to the universe"â€”meets the ancient structure of divination. This isn't your grandma's stiff oracle; this is a modern tool for the seeker, blending futuristic design with timeless wisdom.</p>
            
            <h3 class="text-xl font-bold text-teal-400 border-b border-gray-700 pb-1 mt-6 mb-3">METHODOLOGY: How to Play (Cast the Coil Ritual)</h3>
            <p class="mb-4">The entire Oracle reading focuses on three critical areas of life, aligned in a 3-row grid: <strong>Vitality, Prosperity, and Destiny.</strong></p>

            <h4 class="font-semibold text-yellow-300 mt-4">Step 1: Focus and Breathe</h4>
            <p class="italic text-gray-400">Breathe Tesla-style: Inhale for 3 counts, hold for 6 counts, and exhale for 9 counts. This establishes the digital root loop ($3+6+9 = 18 â†’ 9$) of completion.</p>

            <h4 class="font-semibold text-yellow-300 mt-4">The 6 Glyphs of Resonance</h4>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4 text-gray-300">
                <li>â–£ <strong>Square:</strong> Balance, Foundation, Stability</li>
                <li>â—Ž <strong>Spiral:</strong> Emission, Momentum, Creative Force</li>
                <li>â–² <strong>Triangle:</strong> Structure, Creation, Legacy</li>
                <li>â‰‹ <strong>Wave:</strong> Flow, Adaptability, Change</li>
                <li>â˜… <strong>Star:</strong> Prime, Potential, Insight</li>
                <li>ðŸ‘‘ <strong>Crown:</strong> Completion, Apex, Fulfillment</li>
            </ul>
        </div>
    </div>

    <script>
        // ==================== FINAL FIXED CONFIGURATION (VERCEL READY) ====================
        const grokApiUrl = "/api/grok";  // â† This is the only line you needed to change!

        window.showScreen = (screenId, previousScreenId) => {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            document.querySelectorAll('.screen').forEach(s => s.hidden = true);
            document.getElementById(screenId).hidden = false;
            if (screenId === 'grid-screen') renderGrid();
        };

        const ORIGINAL_ANALYSIS_TEXT = 'Get Deep Dive Directive';
        const CLOSE_ANALYSIS_TEXT = 'Close Deep Dive';
        const PLAY_AUDIO_TEXT = 'Read Transmission Aloud';
        const STOP_AUDIO_TEXT = 'Stop Audio';

        window.currentSymbols = {
            v1: 'Star', v2: 'Square', v3: 'Spiral',
            p1: 'Wave', p2: 'Star', p3: 'Crown',
            d1: 'Triangle', d2: 'Wave', d3: 'Square'
        };
        window.currentReadingData = { rawTextForTTS: "", contextForGrok: "" }; 

        const symbols = ['Square', 'Spiral', 'Triangle', 'Wave', 'Star', 'Crown'];
        const symbolDisplay = {
            'Square': { char: 'â–£', color: 'text-blue-300', value: 1 },
            'Spiral': { char: 'â—Ž', color: 'text-yellow-400', value: 2 },
            'Triangle': { char: 'â–²', color: 'text-green-300', value: 3 },
            'Wave': { char: 'â‰‹', color: 'text-gray-300', value: 4 },
            'Star': { char: 'â˜…', color: 'text-purple-300', value: 5 },
            'Crown': { char: 'ðŸ‘‘', color: 'text-pink-300', value: 6 }
        };
        const getRandomSymbol = () => symbols[Math.floor(Math.random() * symbols.length)];

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        function setLoading(elementId, isLoading, defaultText = '', spinnerClass = 'text-yellow-400') {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (isLoading) {
                el.innerHTML = `<div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 ${spinnerClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Transmitting...</span>
                </div>`;
                el.disabled = true;
            } else {
                el.innerHTML = defaultText;
                el.disabled = false;
            }
        }

        function renderDiceSlot(id) {
            const s = window.currentSymbols[id];
            const d = symbolDisplay[s];
            return `<div id="${id}" class="dice-slot flex justify-center items-center w-full aspect-square bg-gray-800 rounded-xl shadow-lg border border-gray-700 text-5xl sm:text-7xl font-extrabold ${d.color}">${d.char}</div>`;
        }

        function renderRowGroup(rowPrefix, label) {
            return `
                <div class="flex items-center justify-center mx-auto my-4 w-full max-w-sm p-4 rounded-xl border border-gray-700 bg-gray-900/50 shadow-2xl">
                    <button class="text-yellow-400 text-4xl cursor-pointer mr-4 hover:text-yellow-300 transition-colors" onclick="spinRow('${rowPrefix}')">â–³</button>
                    <div class="flex-grow">
                        <div class="text-left text-sm text-gray-400 mb-2 font-semibold">${label}</div>
                        <div class="grid grid-cols-3 gap-3">
                            ${renderDiceSlot(rowPrefix + '1')}
                            ${renderDiceSlot(rowPrefix + '2')}
                            ${renderDiceSlot(rowPrefix + '3')}
                        </div>
                    </div>
                </div>`;
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            if (!container.innerHTML) {
                container.innerHTML = [
                    renderRowGroup('v', '1. Vitality (Body, Intuition, Health)'),
                    renderRowGroup('p', '2. Prosperity (Abundance, Resources, Action)'),
                    renderRowGroup('d', '3. Destiny (Path, Potential, Highest Self)')
                ].join('');
            } else {
                Object.keys(window.currentSymbols).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        const d = symbolDisplay[window.currentSymbols[id]];
                        el.textContent = d.char;
                        el.className = `dice-slot flex justify-center items-center w-full aspect-square bg-gray-800 rounded-xl shadow-lg border border-gray-700 text-5xl sm:text-7xl font-extrabold ${d.color}`;
                    }
                });
            }
        }

        window.spinRow = (prefix) => {
            const ids = [`${prefix}1`, `${prefix}2`, `${prefix}3`];
            const spinInt = setInterval(() => {
                ids.forEach(id => window.currentSymbols[id] = getRandomSymbol());
                renderGrid();
            }, 100);
            setTimeout(() => {
                clearInterval(spinInt);
                ids.forEach((id, i) => setTimeout(() => {
                    window.currentSymbols[id] = getRandomSymbol();
                    renderGrid();
                }, i * 200));
            }, 1500);
        };

        function calculateReading(c1, c2, c3, rowName) {
            const arr = [c1, c2, c3];
            const uniq = new Set(arr);
            const sum = arr.reduce((a, s) => a + symbolDisplay[s].value, 0);
            let resonance = uniq.size === 1 ? `Triple ${c1.toUpperCase()} Manifestation` :
                           uniq.size === 3 ? "Synergistic Flux" : "Paired Polarity";
            let summary = "";

            if (rowName === 'Vitality') {
                summary = `Your **Intuitive Current** flows through *${arr.join(', ')}*. Align body and mind in adaptive, energized flow.`;
                if (uniq.size === 1) {
                    if (c1 === 'Square') summary = "â–£â–£â–£ **Static Charge:** Break a routine to release blocked energy.";
                    if (c1 === 'Spiral') summary = "â—Žâ—Žâ—Ž **Emission Overload:** One breathing ritual (3-6-9) to focus raw power.";
                    if (c1 === 'Wave') summary = "â‰‹â‰‹â‰‹ **Tsunami of Adaptation:** Surrender everything. Total transformation is here.";
                }
            } else if (rowName === 'Prosperity') {
                summary = `Your **Resource Stream** activates via *${arr.join(', ')}*. Structure + action = abundance.`;
                if (uniq.size === 1) {
                    if (c1 === 'Square') summary = "â–£â–£â–£ **Financial Fortress:** Safe, slow, guaranteed growth. Avoid risk.";
                    if (c1 === 'Spiral') summary = "â—Žâ—Žâ—Ž **Vortex of Expansion:** Anchor the flow now or lose it.";
                    if (c1 === 'Crown') summary = "ðŸ‘‘ðŸ‘‘ðŸ‘‘ **Ultimate Wealth:** Unexpected reward from past goodwill incoming.";
                }
            } else if (rowName === 'Destiny') {
                summary = `Your **Path Alignment** is shaped by *${arr.join(', ')}*. Synthesize structure and flow.`;
                if (uniq.size === 1) {
                    if (c1 === 'Triangle') summary = "â–²â–²â–² **Pure Blueprint:** Do not deviate. Execute perfectly.";
                    if (c1 === 'Wave') summary = "â‰‹â‰‹â‰‹ **Uncharted Current:** Be the pioneer. Zero fixed plans.";
                    if (c1 === 'Star') summary = "â˜…â˜…â˜… **Prime Alignment:** You are on purpose. Watch for 3 synchronicities.";
                }
            }

            return { resonance, summary, sum, c1, c2, c3 };
        }

        window.generatePrediction = () => {
            const { v1,v2,v3,p1,p2,p3,d1,d2,d3 } = window.currentSymbols;
            const vitality = calculateReading(v1,v2,v3,'Vitality');
            const prosperity = calculateReading(p1,p2,p3,'Prosperity');
            const destiny = calculateReading(d1,d2,d3,'Destiny');
            const totalSum = vitality.sum + prosperity.sum + destiny.sum;
            const teslaMod = totalSum % 9 || 9;

            let finalTheme = "", finalInt = "";
            if (teslaMod === 3) { finalTheme = "The Principle of **CREATION** (3)"; finalInt = "You are the spark. Build now."; }
            else if (teslaMod === 6) { finalTheme = "The Principle of **RESONANCE** (6)"; finalInt = "Amplify harmony in all relations."; }
            else if (teslaMod === 9) { finalTheme = "The Principle of **HARMONY** (9)"; finalInt = "Mastery achieved. Walk in quiet power."; }
            else { finalTheme = `The Principle of **FLUX** (${teslaMod})`; finalInt = "Adapt swiftly. Growth through change."; }

            const format = t => t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            const html = `
                <div class="p-6 w-full">
                    <p class="text-center text-3xl font-extrabold text-teal-400 mb-6">${finalTheme}</p>
                    <p class="text-center text-gray-200 mb-8">${format(finalInt)}</p>

                    ${['Vitality', 'Prosperity', 'Destiny'].map((area, i) => {
                        const r = [vitality, prosperity, destiny][i];
                        return `<div class="mb-8">
                            <h3 class="text-xl font-bold text-yellow-400 border-b border-yellow-800 pb-1 mb-3">
                                ${i===0?'VITALITY':i===1?'PROSPERITY':'DESTINY'}
                            </h3>
                            <p class="font-semibold text-teal-300">Resonance: ${r.resonance}</p>
                            <p class="text-gray-200">${format(r.summary)}</p>
                        </div>`;
                    }).join('')}

                    <div class="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="analysis-button" class="bg-purple-600 hover:bg-purple-700 text-white font-extrabold py-3 px-8 rounded-xl shadow-xl"
                            onclick="getGrokAnalysis(window.currentReadingData.contextForGrok)">
                            ${ORIGINAL_ANALYSIS_TEXT}
                        </button>
                        <button id="audio-button" class="bg-teal-600 hover:bg-teal-700 text-white font-extrabold py-3 px-8 rounded-xl shadow-xl"
                            onclick="generateAndPlayAudio()">
                            ${PLAY_AUDIO_TEXT}
                        </button>
                    </div>
                    <div id="analysis-output"></div>
                </div>`;

            const context = `Theme: ${finalTheme} | Mod: ${teslaMod} | V: ${v1}-${v2}-${v3} | P: ${p1}-${p2}-${p3} | D: ${d1}-${d2}-${d3}`;
            window.currentReadingData = {
                rawTextForTTS: `${finalTheme}. ${finalInt}. Vitality: ${vitality.summary}. Prosperity: ${prosperity.summary}. Destiny: ${destiny.summary}`,
                contextForGrok: context
            };

            document.getElementById('prediction-output').innerHTML = html;
            showScreen('prediction-screen', 'grid-screen');
        };

        // ==================== GROK ANALYSIS â€” NOW 100% VERCEL SAFE ====================
        window.getGrokAnalysis = async (readingContext) => {
            const output = document.getElementById('analysis-output');
            const btn = document.getElementById('analysis-button');
            
            if (output.innerHTML.trim()) {
                output.innerHTML = '';
                btn.innerHTML = ORIGINAL_ANALYSIS_TEXT;
                return;
            }

            setLoading('analysis-button', true, ORIGINAL_ANALYSIS_TEXT);

            const system = "You are the Tesla Oracle's AI Conduit, powered by Grok. Synthesize the reading into one powerful, actionable directive/mantra blending 3-6-9 themes with real steps. Inspiring, visionary, esoteric tone. Start with 'Directive: '";
            const user = `Reading: ${readingContext}. Generate the Directive.`;

            try {
                const res = await fetch(grokApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "grok-beta",
                        messages: [
                            { role: "system", content: system },
                            { role: "user", content: user }
                        ],
                        temperature: 0.8
                    })
                });

                setLoading('analysis-button', false);

                if (res.ok) {
                    const data = await res.json();
                    const text = data.choices?.[0]?.message?.content || "The coil is silent...";
                    output.innerHTML = `
                        <div class="p-6 mt-8 bg-gray-900 border-2 border-purple-500 rounded-xl shadow-inner">
                            <p class="text-lg text-purple-400 font-bold mb-3">GROK CONDUIT TRANSMISSION</p>
                            <p class="text-gray-100 whitespace-pre-wrap leading-relaxed">${text}</p>
                        </div>`;
                    btn.innerHTML = CLOSE_ANALYSIS_TEXT;
                } else {
                    const err = await res.json();
                    showModal("Error", err.error?.message || "Transmission failed");
                }
            } catch (e) {
                setLoading('analysis-button', false);
                showModal("Network Error", "Check connection or server logs");
            }
        };

        window.generateAndPlayAudio = () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                document.getElementById('audio-button').innerHTML = PLAY_AUDIO_TEXT;
                return;
            }
            const utter = new SpeechSynthesisUtterance(window.currentReadingData.rawTextForTTS);
            utter.lang = 'en-GB';
            utter.rate = 0.9;
            document.getElementById('audio-button').innerHTML = STOP_AUDIO_TEXT;
            utter.onend = () => document.getElementById('audio-button').innerHTML = PLAY_AUDIO_TEXT;
            speechSynthesis.speak(utter);
        };

        document.addEventListener('DOMContentLoaded', renderGrid);
    </script>
</body>
</html>











